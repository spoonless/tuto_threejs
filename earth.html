<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>three.js app</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script src="js/three.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/dat.gui.min.js"></script>
    <script>
      var renderer = new THREE.WebGLRenderer();
      document.body.appendChild(renderer.domElement);

      var camera = new THREE.PerspectiveCamera(45, 1, 0.1, 10000);

      function updateViewportSize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix()
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      window.addEventListener("resize", updateViewportSize);
      updateViewportSize();

      var scene = new THREE.Scene();

      var cubeTextureLoader = new THREE.CubeTextureLoader();
      var textureLoader = new THREE.TextureLoader();

      // milkyway
      cubeTextureLoader.setPath('maps/milkyway/');
      var milkyway = cubeTextureLoader.load([
        "1.jpg",
        "2.jpg",
        "3.jpg",
        "4.jpg",
        "5.jpg",
        "6.jpg",
      ]);
      scene.background = milkyway;

      function createAxesHelperOnLayer(layer) {
        var axes = new THREE.AxesHelper(1.6);
        axes.material.depthTest = false;
        axes.renderOrder = 100;
        axes.layers.set(layer);
        return axes;
      }

      // earth
      var planetGeo = new THREE.SphereGeometry(1, 64, 48);
      var earth = new THREE.Group();
      earth.add(createAxesHelperOnLayer(30));
      scene.add(earth);

      // atmosphere
      var atmosphereMat = new THREE.MeshBasicMaterial({

        color: 0x1594c6,
        transparent:true,
        side: THREE.BackSide,
        opacity: .3,

      });
      var atmosphere = new THREE.Mesh(planetGeo, atmosphereMat);
      atmosphere.scale.setScalar(1.01);
      earth.add(atmosphere);

      // earth planet
      textureLoader.setPath("maps/earth/earth_")
      var earthMat = new THREE.MeshStandardMaterial({

        map: textureLoader.load("color.jpg"),
        normalMap: textureLoader.load("normal.jpg"),
        metalness: 0,
        roughness: .8

      });
      var earthPlanet = new THREE.Mesh(planetGeo, earthMat);
      earth.add(earthPlanet);
      earthPlanet.add(createAxesHelperOnLayer(30));

      // clouds
      var cloudsMat = new THREE.MeshStandardMaterial({

        transparent: true,
        alphaMap: textureLoader.load("cloud.jpg"),
        metalness: 0,
        roughness: .5

      });
      var clouds = new THREE.Mesh(planetGeo, cloudsMat);
      clouds.scale.setScalar(1.005);
      earth.add(clouds);
      clouds.add(createAxesHelperOnLayer(30));

      // moon
      textureLoader.setPath("maps/moon/moon_")
      var moon = new THREE.Group();
      earth.add(moon);
      moon.add(createAxesHelperOnLayer(31));

      var moonMat = new THREE.MeshStandardMaterial({

        map: textureLoader.load("color.jpg"),
        metalness: 0,
        roughness: .9

      });
      // on d√©place la texture le long de l'axe U pour aligner la face visible
      // depuis la terre.
      moonMat.map.offset = new THREE.Vector2(.3, 0);
      moonMat.map.wrapS = THREE.RepeatWrapping;

      var moonPlanet = new THREE.Mesh(planetGeo, moonMat);
      moonPlanet.scale.setScalar(.2723);
      moonPlanet.position.z=24;
      moonPlanet.add(createAxesHelperOnLayer(31));
      moon.add(moonPlanet);

      // lights
      var ambientLight = new THREE.AmbientLight(0x404040 , .15); // soft white light
      scene.add(ambientLight);

      var sun = new THREE.DirectionalLight(0xffffff, 1.1);
      sun.position.set(50, 15, 50);
      scene.add(sun);

      camera.position.z = 4;

      var controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enablePan = false;
      controls.minDistance = 2;
      controls.maxDistance = 30;

      var params = {
        dureeJournee: 30,
        vitesseNuages: 1.15,
        axesTerre: false,
        axesLune: false,
      };
      var gui = new dat.GUI();
      gui.add(params, "axesTerre").name("Axes Terre").onChange(function(v) {camera.layers.toggle(30)});
      gui.add(params, "axesLune").name("Axes Lune").onChange(function(v) {camera.layers.toggle(31)});
      gui.add(params, "dureeJournee").min(1).max(60).name("Rotation en s");
      gui.add(params, "vitesseNuages").min(0).max(2).name("Nuages");

      var start = null;
      var wsEarthPosition = new THREE.Vector3();

      function animate(t) {
        if (start == null) {
          start = t;
        }
        var delai = t - start;

        controls.update();

        var rotationTerre = 2 * Math.PI * delai / (params.dureeJournee * 1000);
        earthPlanet.rotation.y = rotationTerre;
        clouds.rotation.y = rotationTerre * params.vitesseNuages ;
        moon.rotation.y = rotationTerre / 27.321;
        earth.getWorldPosition(wsEarthPosition)
        moonPlanet.lookAt(wsEarthPosition);

        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      requestAnimationFrame(animate);
    </script>
  </body>
</html>
